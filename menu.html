<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Menu â€¢ Cart â€¢ Receipt</title>
  <style>
    :root { --gap: 16px; --radius: 14px; --shadow: 0 8px 24px rgba(0,0,0,.3); }
    * { box-sizing: border-box; }

    main { max-width: 1100px; margin: 24px auto; padding: 0 var(--gap); }
    h1 { margin: 0 0 16px; font-size: 28px; display:flex; align-items:center; justify-content:space-between; color:#e8eef5; }

    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(230px, 1fr)); gap: var(--gap); }
    .card { background: #11161c; border: 1px solid #1f2833; border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow); display: flex; flex-direction: column; }
    .thumb { width: 100%; aspect-ratio: 1/1; object-fit: cover; background: #0b0d10; }
    .card-body { padding: 12px; display: grid; gap: 8px; }
    .title { font-weight: 700; line-height: 1.2; min-height: 2.4em; color: #fff; }
    .desc { color: #9fb2c3; font-size: 14px; min-height: 2.6em; }
    .meta { display:flex; align-items:center; justify-content:space-between; color: #9fb2c3; }
    .price { font-weight: 700; color: #34d399; }
    .stock { font-size: 12px; padding: 2px 8px; border-radius: 999px; border: 1px solid #1f2833; background:#0b0d10; }
    .out { color:#ef4444; border-color:#3b1f1f; background:#1a0f0f; }
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 10px 12px; background: linear-gradient(140deg, #34d399, #22d3ee); color: #04110a; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; }
    .btn[disabled]{ opacity:.6; cursor:not-allowed; }

    /* Cart button */
    .cart-btn {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 999px;
      background: #0b0d10;
      border: 1px solid #41566b;
      color: #e8eef5;
      cursor: pointer;
      font-weight: 600;
    }
    .badge {
      position: absolute;
      top: -6px;
      right: -6px;
      background: #ef4444;
      color: #fff;
      font-size: 12px;
      min-width: 20px;
      height: 20px;
      border-radius: 50%;
      display: grid;
      place-items: center;
    }

    .cart-panel { position: fixed; top: 0; right: 0; width: min(420px, 100%); height: 100dvh; background: #11161c; border-left: 1px solid #1f2833; transform: translateX(100%); transition: transform .28s ease; z-index: 50; display: flex; flex-direction: column; color: #e8eef5; }
    .cart-panel.open { transform: translateX(0); }
    .cart-head { display: flex; align-items: center; justify-content: space-between; padding: 14px var(--gap); border-bottom: 1px solid #1f2833; }
    .cart-list { flex: 1; overflow: auto; padding: var(--gap); display: grid; gap: 12px; }
    .cart-list img { width: 48px; height: 48px; object-fit: cover; border-radius: 6px; }
    .cart-foot { border-top: 1px solid #1f2833; padding: 14px var(--gap); display: grid; gap: 10px; }
    .total { display: flex; align-items: center; justify-content: space-between; font-weight: 700; color:#fff; }

    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,.6); opacity: 0; visibility: hidden; transition: opacity .28s ease; z-index: 40; }
    .overlay.show { opacity: 1; visibility: visible; }

    .modal { position: fixed; inset: 0; display: grid; place-items: center; z-index: 60; opacity: 0; visibility: hidden; transition: opacity .2s ease; }
    .modal.open { opacity: 1; visibility: visible; }
    .sheet { width: min(720px, 92vw); max-height: 86vh; overflow: auto; background: #11161c; border: 1px solid #1f2833; border-radius: 16px; box-shadow: var(--shadow); color: #e8eef5; }
    .sheet .head { display: flex; justify-content: space-between; align-items: center; padding: 14px 16px; border-bottom: 1px solid #1f2833; }
    .sheet .body { padding: 16px; display: grid; gap: 12px; }
    .receipt-items { display: grid; gap: 8px; }
    .receipt-row { display: grid; grid-template-columns: 48px 1fr auto auto; gap: 10px; align-items: center; }
    .receipt-row img { width: 48px; height: 48px; object-fit: cover; border-radius: 8px; background: #0b0d10; }
    .muted { color: #9fb2c3; font-size: 14px; }
    .row { display:flex; align-items:center; justify-content:space-between; }
    .filebox { display:grid; gap:8px; border:1px dashed #41566b; padding:12px; border-radius:12px; background:#0b0d10; }

    .toast { position: fixed; left: 50%; bottom: 24px; transform: translateX(-50%); background: #11161c; color: #fff; padding: 10px 14px; border-radius: 999px; opacity: 0; transition: opacity .2s ease, transform .2s ease; pointer-events: none; z-index: 70; }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(-6px); }
  </style>
</head>
<body>
  <main>
    <h1>
      Menu
      <button id="openCart" class="cart-btn">
        ðŸ›’ <span id="cartCount" class="badge">0</span>
      </button>
    </h1>
    <div id="grid" class="grid" aria-live="polite"></div>
  </main>

  <!-- Cart Drawer -->
  <div id="overlay" class="overlay" role="presentation"></div>
  <aside id="cart" class="cart-panel" aria-label="Shopping cart" aria-hidden="true">
    <div class="cart-head">
      <strong>My Cart</strong>
      <button id="closeCart" class="btn" style="background:#222;color:#fff">Cancel</button>
    </div>
    <div id="cartList" class="cart-list"></div>
    <div class="cart-foot">
      <div class="total"><span>Total</span><span id="cartTotal">â‚±0.00</span></div>
      <button id="checkoutBtn" class="btn">Checkout</button>
      <button id="signinBtn" class="btn" style="display:none;background:#2563eb">Sign In</button>
    </div>
  </aside>

  <!-- Receipt Modal -->
  <div id="receiptModal" class="modal" aria-hidden="true" aria-labelledby="rcptTitle">
    <div class="sheet" role="dialog" aria-modal="true">
      <div class="head">
        <strong id="rcptTitle">Receipt</strong>
        <button id="closeReceiptBtn" class="btn" style="background:#222;color:#fff">Close  </button>
      </div>
      <div class="body">
        <div class="row">
          <div>
            <div><strong>Order ID:</strong> <span id="rcptOrderId">â€”</span></div>
            <div class="muted">Created: <span id="rcptCreated">â€”</span></div>
          </div>
        </div>
        <div id="rcptItems" class="receipt-items"></div>
        <div class="row" style="font-weight:700">
          <span>Total</span>
          <span id="rcptTotal">â‚±0.00</span>
        </div>

        <!-- Proof of Payment -->
        <div class="filebox">
          <div><strong>Submit proof of payment</strong> <span class="muted">(image only)</span></div>
          <input id="proofFile" type="file" accept="image/*" />
          <div class="row">
            <small class="muted" id="proofStatus">No file selected</small>
            <button id="submitOrderBtn" class="btn" disabled>Submit Order</button>
          </div>
          <div id="proofPreview" class="muted"></div>
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- Firebase + Cart JS -->
  <script type="module">
    import { initializeApp, getApp, getApps } from 'https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js';
    import { getFirestore, collection, getDocs, addDoc, serverTimestamp, doc, updateDoc, increment } from 'https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js';
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/11.0.0/firebase-storage.js';

    const firebaseConfig = {
      apiKey: 'AIzaSyCHCZ_SAvTxHYjgmRfiCF3fW2SzB3YnFh8',
      authDomain: 'my-moonbucks-firebase-id.firebaseapp.com',
      projectId: 'my-moonbucks-firebase-id',
      storageBucket: 'my-moonbucks-firebase-id.appspot.com',
      messagingSenderId: '361396425482',
      appId: '1:361396425482:web:557ee43bc8b5af33da20f3'
    };

    const app = getApps().length ? getApp() : initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // DOM refs
    const grid = document.getElementById('grid');
    const cartPanel = document.getElementById('cart');
    const overlay = document.getElementById('overlay');
    const openCartBtn = document.getElementById('openCart');
    const closeCartBtn = document.getElementById('closeCart');
    const cartCount = document.getElementById('cartCount');
    const cartList = document.getElementById('cartList');
    const cartTotal = document.getElementById('cartTotal');
    const checkoutBtn = document.getElementById('checkoutBtn');
    const signinBtn = document.getElementById('signinBtn');
    const toastEl = document.getElementById('toast');
    const rcptOrderId = document.getElementById('rcptOrderId');
    const rcptCreated = document.getElementById('rcptCreated');
    const rcptItems = document.getElementById('rcptItems');
    const rcptTotal = document.getElementById('rcptTotal');
    const proofFile = document.getElementById('proofFile');
    const proofStatus = document.getElementById('proofStatus');
    const submitOrderBtn = document.getElementById('submitOrderBtn');
    const proofPreview = document.getElementById('proofPreview');
    const closeReceiptBtn = document.getElementById('closeReceiptBtn');

    // State
    const CART_KEY = 'moonbucks_cart_v1';
    let cart = loadCart();
    let lastOrder = null;
    const productMap = new Map();

    const CLOSE_RECEIPT_ON_SUBMIT = 'success';

    // Init
    updateCartBadge();
    renderCart();
    await renderProducts();

    onAuthStateChanged(auth, (user) => {
      if (user) { checkoutBtn.style.display = 'block'; signinBtn.style.display = 'none'; }
      else { checkoutBtn.style.display = 'none'; signinBtn.style.display = 'block'; }
    });

    // Events
    openCartBtn.addEventListener('click', openCart);
    closeCartBtn.addEventListener('click', closeCart);
    overlay.addEventListener('click', () => { closeCart(); closeReceipt(); });
    checkoutBtn.addEventListener('click', onCheckout);
    signinBtn.addEventListener('click', () => location.href = 'Login.html');
    proofFile.addEventListener('change', onFileSelect);
    submitOrderBtn.addEventListener('click', attachProof);
    closeReceiptBtn.addEventListener('click', closeReceipt);

    // Products
    async function renderProducts(){
      grid.textContent = '';
      productMap.clear();
      try {
        const snap = await getDocs(collection(db, 'products'));
        if (snap.empty) { grid.append(emptyState('No products found')); return; }
        for (const d of snap.docs) {
          const p = normalizeProduct({ id: d.id, ...d.data() });
          productMap.set(p.id, p);
          grid.append(productCard(p));
        }
      } catch (err) {
        console.error(err);
        grid.append(errorState('Failed to load products'));
      }
    }

    function normalizeProduct(p){
      return {
        id: p.id,
        name: String(p.name ?? 'Unnamed Product'),
        description: String(p.description ?? ''),
        price: typeof p.price === 'number' ? p.price : parseFloat(p.price || '0') || 0,
        imageUrl: p.imageUrl || './Coffee.png',
        stock: typeof p.stock === 'number' ? p.stock : parseInt(p.stock || '0', 10)
      };
    }

    function productCard(p){
      const card = document.createElement('article'); 
      card.className = 'card';
      const img = document.createElement('img');
      img.className = 'thumb';
      img.loading = 'lazy';
      img.src = p.imageUrl || './Coffee.png';
      img.alt = p.name;
      const body = document.createElement('div'); body.className = 'card-body';
      const title = document.createElement('div'); title.className = 'title'; title.textContent = p.name;
      const desc = document.createElement('div'); desc.className = 'desc'; desc.textContent = p.description;
      const meta = document.createElement('div'); meta.className = 'meta';
      const price = document.createElement('div'); price.className = 'price'; price.textContent = formatCurrency(p.price);
      const stock = document.createElement('div'); stock.className = 'stock' + (p.stock <= 0 ? ' out' : ''); stock.textContent = p.stock > 0 ? `${p.stock} left` : 'Out of stock';
      meta.append(price, stock);
      const btn = document.createElement('button'); btn.className = 'btn'; btn.type = 'button';
      if (p.stock <= 0) { btn.textContent = 'Unavailable'; btn.disabled = true; } 
      else { btn.textContent = 'Add to cart'; btn.addEventListener('click', () => addToCart(p)); }
      body.append(title, desc, meta, btn); card.append(img, body); 
      return card;
    }

    // Cart
    function addToCart(p){
      const max = Math.max(0, p.stock || 0);
      const inCart = cart.find(i => i.id === p.id)?.qty || 0;
      if (inCart >= max) { showToast('No more stock available'); return; }
      const idx = cart.findIndex(i => i.id === p.id);
      if (idx >= 0) cart[idx].qty += 1;
      else cart.push({ id: p.id, name: p.name, price: p.price, imageUrl: p.imageUrl, qty: 1, stock: max });
      saveCart(); updateCartBadge(); renderCart(); showToast('Added to cart');
    }

    function loadCart(){ try { return JSON.parse(localStorage.getItem(CART_KEY) || '[]'); } catch { return []; } }
    function saveCart(){ localStorage.setItem(CART_KEY, JSON.stringify(cart)); }
    function updateCartBadge(){ cartCount.textContent = String(cart.reduce((n, i) => n + i.qty, 0)); }

    function renderCart(){
      cartList.textContent = '';
      if (!cart.length) { cartList.append(emptyState('Your cart is empty')); cartTotal.textContent = formatCurrency(0); return; }
      for (const item of cart) cartList.append(cartRow(item));
      cartTotal.textContent = formatCurrency(cart.reduce((sum, i) => sum + i.qty * i.price, 0));
    }

    function cartRow(item){
      const row = document.createElement('div'); row.className = 'cart-item';
      const img = document.createElement('img'); img.src = item.imageUrl || './Coffee.png'; img.alt = item.name;
      const meta = document.createElement('div');
      const title = document.createElement('div'); title.className = 'ci-title'; title.textContent = item.name;
      const price = document.createElement('div'); price.textContent = formatCurrency(item.price);
      const qty = document.createElement('div'); qty.className = 'muted'; qty.textContent = `Ã— ${item.qty}`;
      meta.append(title, price, qty);
      row.append(img, meta); 
      return row;
    }

    // Checkout
    async function onCheckout(){
      const user = auth.currentUser;
      if (!user) { showToast('Please sign in first'); return; }
      if (!cart.length) { showToast('Cart is empty'); return; }
      for (const item of cart) {
        const live = productMap.get(item.id);
        const available = live ? live.stock : 0;
        if (item.qty > available) { showToast(`Only ${available} left for ${item.name}`); return; }
      }
      checkoutBtn.disabled = true;
      try {
        const order = {
          userId: user.uid,
          items: cart.map(i => ({ productId: i.id, name: i.name, price: i.price, qty: i.qty, imageUrl: i.imageUrl || null })),
          total: cart.reduce((s, i) => s + i.qty * i.price, 0),
          status: 'ongoing',
          paymentStatus: 'pending',
          deliveryStatus: 'pending',
          createdAt: serverTimestamp()
        };
        const docRef = await addDoc(collection(db, 'orders'), order);
        lastOrder = { id: docRef.id, ...order, createdAtLocal: new Date() };
        for (const it of cart){ await updateDoc(doc(db,'products',it.id),{stock:increment(-it.qty)}); }
        cart = []; saveCart(); updateCartBadge(); renderCart(); closeCart();
        populateReceipt(lastOrder); openReceipt(); showToast('Order placed. Submit proof to confirm.');
      } catch (err) { console.error(err); showToast('Checkout failed'); } 
      finally { checkoutBtn.disabled = false; }
    }

    function populateReceipt(order){
      rcptOrderId.textContent = order.id; 
      rcptCreated.textContent = order.createdAtLocal.toLocaleString(); 
      rcptTotal.textContent = formatCurrency(order.total);
      rcptItems.textContent='';
      for (const it of order.items) {
        const row = document.createElement('div'); row.className='receipt-row';
        const img = document.createElement('img'); img.src = it.imageUrl || './Coffee.png'; img.alt = it.name;
        const name = document.createElement('div'); name.textContent = it.name;
        const qty = document.createElement('div'); qty.className='muted'; qty.textContent=`Ã— ${it.qty}`;
        const line = document.createElement('div'); line.textContent = formatCurrency(it.price * it.qty);
        row.append(img, name, qty, line); rcptItems.append(row);
      }

      proofFile.value = '';
      submitOrderBtn.disabled = true;
      proofStatus.textContent = 'No file selected';
      proofPreview.textContent='';
    }

    // Proof upload
    function onFileSelect(){
      const f = proofFile.files?.[0];
      if (!f) { submitOrderBtn.disabled = true; proofStatus.textContent = 'No file selected'; proofPreview.textContent = ''; return; }
      if (!f.type.startsWith('image/')) { submitOrderBtn.disabled = true; proofStatus.textContent = 'Only images allowed'; proofPreview.textContent = ''; return; }
      const url = URL.createObjectURL(f);
      proofPreview.innerHTML = `<img src="${url}" alt="Preview" style="max-width:120px;border-radius:8px;">`;
      proofStatus.textContent = `${f.name} (${Math.round(f.size/1024)} KB)`; 
      submitOrderBtn.disabled = false;
    }

    async function attachProof(){
      if (!lastOrder){ showToast('No order'); return; }
      const file = proofFile.files?.[0]; if (!file){ showToast('Select an image first'); return; }
      try {
        submitOrderBtn.disabled = true;
        if (CLOSE_RECEIPT_ON_SUBMIT === 'immediate') {
          closeReceipt();
          showToast('Uploading proof...');
        }

        const path = `proofs/${lastOrder.id}/${Date.now()}_${file.name}`;
        const fileRef = storageRef(storage, path);
        await uploadBytes(fileRef, file);
        const url = await getDownloadURL(fileRef);
        await updateDoc(doc(db,'orders',lastOrder.id),{proofUrl:url,paymentStatus:'submitted'});

        proofPreview.innerHTML = `<img src="${url}" alt="Proof" style="max-width:120px;border-radius:8px;">`;
        proofStatus.textContent = 'Uploaded to server';
        showToast('Proof submitted. Waiting for admin confirmation.');

        if (CLOSE_RECEIPT_ON_SUBMIT === 'success') {
          closeReceipt();
        }
      } catch (e){
        console.error(e);
        showToast('Submit failed');
        submitOrderBtn.disabled = false;
        if (CLOSE_RECEIPT_ON_SUBMIT === 'immediate') {
          openReceipt();
        }
      }
    }

    // Utils
    function formatCurrency(n){ return `â‚±${(n || 0).toFixed(2)}`; }
    function emptyState(text){ const d=document.createElement('div'); d.style.border='1px dashed #41566b'; d.style.padding='24px'; d.style.textAlign='center'; d.style.color='#9fb2c3'; d.textContent=text; return d; }
    function errorState(text){ const el = emptyState(text); el.style.color='#ef4444'; return el; }
    function openCart(){cartPanel.classList.add('open');overlay.classList.add('show');}
    function closeCart(){cartPanel.classList.remove('open');overlay.classList.remove('show');}
    function openReceipt(){document.getElementById('receiptModal').classList.add('open');overlay.classList.add('show');}
    function closeReceipt(){document.getElementById('receiptModal').classList.remove('open');overlay.classList.remove('show');}
    function showToast(m){toastEl.textContent=m;toastEl.classList.add('show');setTimeout(()=>toastEl.classList.remove('show'),1500);} 
  </script>
</body>
</html>
