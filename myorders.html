<!DOCTYPE html> 
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>My Orders</title>
  <style>
    main, #orders, #gate {
      background: transparent !important;
    }

    :root { --gap: 16px; --radius: 14px; --shadow: 0 8px 24px rgba(0,0,0,.3); }
    * { box-sizing: border-box; }
    main { max-width: 1100px; margin: 24px auto; padding: 0 var(--gap); }

    h1 {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 16px;
      color: #e8eef5;
    }

    .list { display: grid; gap: var(--gap); }
    .card { background:#11161c; border:1px solid #1f2833; border-radius: var(--radius); box-shadow: var(--shadow); padding: 12px; display:grid; gap: 10px; }
    .row { display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap: wrap; }
    .muted { color:#9fb2c3; font-size: 14px; }
    .chip { display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; border:1px solid #41566b; background:#0b0d10; font-size:14px; color:#e8eef5; }
    .chip.pending { border-color:#eab30833; background:#eab30822; color:#facc15; }
    .chip.cancelled { border-color:#ef444433; background:#ef444422; color:#f87171; }
    .chip.ontheway { border-color:#3b82f633; background:#3b82f622; color:#60a5fa; }
    .chip.delivered { border-color:#22c55e33; background:#22c55e22; color:#4ade80; }
    .items { display:grid; gap:8px; }
    .item { display:grid; grid-template-columns: 48px 1fr auto auto; align-items:center; gap:10px; }
    .item img { width:48px; height:48px; border-radius:8px; object-fit:cover; background:#0b0d10; }
    .total { font-weight: 700; color:#fff; }
    .proof { display:flex; align-items:center; gap:10px; }
    .proof img { max-width: 160px; border-radius: 10px; border:1px solid #1f2833; }

    .btn { display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:8px 12px; border-radius:10px; border:1px solid #41566b; background:#0b0d10; cursor:pointer; text-decoration:none; color:#e8eef5; }
    .empty { border:1px dashed #41566b; border-radius:12px; padding:24px; text-align:center; color:#9fb2c3; }
  </style>
</head>
<body>
  <main>
    <h1>My Orders</h1>
    <div id="gate" class="empty" style="display:none">Please sign in to view your orders.</div>
    <div id="orders" class="list"></div>
  </main>

  <script type="module">
    import { initializeApp, getApp, getApps } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { getFirestore, collection, query, where, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    const fallbackConfig = {
      apiKey: 'AIzaSyCHCZ_SAvTxHYjgmRfiCF3fW2SzB3YnFh8',
      authDomain: 'my-moonbucks-firebase-id.firebaseapp.com',
      projectId: 'my-moonbucks-firebase-id',
      storageBucket: 'my-moonbucks-firebase-id.appspot.com',
      messagingSenderId: '000000000000',
      appId: '1:000000000000:web:0000000000000000'
    };

    const app = getApps().length ? getApp() : initializeApp(window.FIREBASE_CONFIG || fallbackConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const ordersEl = document.getElementById('orders');
    const gate = document.getElementById('gate');

    let unsub = null;
    let cached = [];

    onAuthStateChanged(auth, (user) => {
      if (!user) {
        if (unsub) { unsub(); unsub = null; }
        ordersEl.textContent = '';
        gate.style.display = 'block';
        return;
      }
      gate.style.display = 'none';
      bind(user.uid);
    });

    function bind(uid){
      if (!uid) { const u = auth.currentUser; if (!u) return; uid = u.uid; }
      if (unsub) { unsub(); unsub = null; }
      ordersEl.textContent = '';
      ordersEl.append(empty('Loading your orders...'));

      const col = collection(db, 'orders');
      const q = query(col, where('userId', '==', uid));
      unsub = onSnapshot(q, (snap) => {
        cached = snap.docs.map(d => normalize({ id: d.id, ...d.data() }));
        cached.sort((a,b) => (b.createdAt?.getTime?.() || 0) - (a.createdAt?.getTime?.() || 0));
        render(cached);
      }, () => {
        ordersEl.textContent = '';
        ordersEl.append(empty('Failed to load orders.'));
      });
    }

    function normalize(o){
      return {
        id: o.id,
        items: Array.isArray(o.items) ? o.items : [],
        total: typeof o.total === 'number' ? o.total : parseFloat(o.total || '0') || 0,
        paymentStatus: 'complete',  // Force it to "complete"
        adminStatus: String(o.status || 'ongoing'),
        deliveryStatus: o.deliveryStatus || null,
        proofDataUrl: o.proofDataUrl || null,
        proofUrl: o.proofUrl || null,
        createdAt: o.createdAt?.toDate ? o.createdAt.toDate() : new Date()
      };
    }

    function mapStatus(o){
      if (o.deliveryStatus) {
        switch (String(o.deliveryStatus)) {
          case 'pending': return 'Pending';
          case 'cancelled': return 'Cancelled';
          case 'on_the_way': return 'The rider is on its ways';
          case 'delivered': return 'Delivered';
        }
      }
      if (o.adminStatus === 'rejected') return 'Cancelled';
      if (o.adminStatus === 'ongoing' || o.adminStatus === 'accepted') return 'Pending';
      return 'Pending';
    }

    function render(list){
      ordersEl.textContent = '';
      if (!list.length) { ordersEl.append(empty('No orders yet.')); return; }
      for (const o of list) ordersEl.append(card(o));
    }

    function card(o){
      const c = document.createElement('div'); c.className = 'card';

      const statusLabel = mapStatus(o);
      const chip = document.createElement('span');
      chip.className = 'chip ' + chipClass(statusLabel);
      chip.textContent = statusLabel;

      const top = document.createElement('div'); top.className = 'row';
      const left = document.createElement('div');
      left.innerHTML = `
        <div><strong>Order:</strong> ${escapeHtml(o.id)}</div>
        <div class="muted">Placed: ${o.createdAt.toLocaleString()}</div>
        <div class="muted">Payment: Complete</div>
      `;
      const right = document.createElement('div'); right.append(chip);
      top.append(left, right);

      const items = document.createElement('div'); items.className = 'items';
      for (const it of o.items) {
        const row = document.createElement('div'); row.className = 'item';
        const img = document.createElement('img'); img.src = it.imageUrl || './Coffee.png'; img.alt = it.name || 'item';
        const name = document.createElement('div'); name.textContent = String(it.name || 'Item');
        const qty = document.createElement('div'); qty.className = 'muted'; qty.textContent = `× ${it.qty || 0}`;
        const line = document.createElement('div'); line.textContent = currency((it.price || 0) * (it.qty || 0));
        row.append(img, name, qty, line); items.append(row);
      }

      const bottom = document.createElement('div'); bottom.className = 'row';
      const total = document.createElement('div'); total.className = 'total'; total.textContent = currency(o.total);
      bottom.append(total);

      const proof = document.createElement('div'); proof.className = 'proof';
      if (o.proofDataUrl) {
        const img = document.createElement('img'); img.src = o.proofDataUrl; img.alt = 'Proof of payment';
        proof.append(img);
      } else if (o.proofUrl) {
        const link = document.createElement('a'); link.href = o.proofUrl; link.target = '_blank'; link.rel = 'noopener'; link.className='btn'; link.textContent='View proof of payment';
        proof.append(link);
      }

      c.append(top, items, bottom);
      if (proof.childElementCount) c.append(proof);
      return c;
    }

    function chipClass(label){
      switch (label){
        case 'Pending': return 'pending';
        case 'Cancelled': return 'cancelled';
        case 'The rider is on its ways': return 'ontheway';
        case 'Delivered': return 'delivered';
        default: return '';
      }
    }

    function currency(n){ return `₱${(n || 0).toFixed(2)}`; }
    function empty(msg){ const d = document.createElement('div'); d.className = 'empty'; d.textContent = msg; return d; }
    function escapeHtml(s){ return String(s).replace(/[&<>"]'/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }
  </script>
</body>
</html>
