<h1></h1>
<div id="userMount" class="users-container">Loading...</div>

<style>
  h1 {
    margin-bottom: 16px;
    color: #c7b7ff;
  }
  .users-container {
    background: rgba(28, 25, 43, 0.9);
    padding: 20px;
    border-radius: 16px;
    box-shadow: 0 8px 24px rgba(0,0,0,.45);
    overflow-x: auto;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
    border-radius: 10px;
    overflow: hidden;
    color: #e7e9ea;
  }
  thead {
    background: #4c1d95;
    color: #fff;
  }
  th, td {
    padding: 12px 10px;
    text-align: left;
  }
  tbody tr:nth-child(even) {
    background: rgba(255,255,255,0.03);
  }
  tbody tr:hover {
    background: rgba(124,58,237,0.15);
  }
  .roleSelect {
    padding: 6px 8px;
    border-radius: 6px;
    border: 1px solid #555;
    background: #1f1f2e;
    color: #e7e9ea;
    font-size: 13px;
  }
  .deleteBtn {
    background: #ef2b4a;
    color: #fff;
    border: none;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    transition: background .2s ease;
  }
  .deleteBtn:hover {
    background: #c81e34;
  }
</style>

<script type="module">
  import { app, db } from "./auth.js";
  import { getAuth } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-auth.js";
  import { collection, onSnapshot, doc, updateDoc, deleteDoc } 
    from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

  const mount = document.getElementById("userMount");
  const auth = getAuth(app);

  // üîÑ Live user list
  onSnapshot(collection(db, "users"), (snap) => {
    if (snap.empty) {
      mount.innerHTML = "<p>No users found</p>";
      return;
    }

    const rows = snap.docs.map(d => {
      const u = d.data();
      const role = u.role || "user";

      if (role === "admin") {
        // show admins but lock controls
        return `
          <tr>
            <td>${u.email || ""}</td>
            <td><strong style="color:#c7b7ff">Admin</strong></td>
            <td>‚Äî</td>
            <td>‚Äî</td>
          </tr>
        `;
      }

      return `
        <tr>
          <td>${u.email || ""}</td>
          <td>${role}</td>
          <td>
            <select data-uid="${d.id}" class="roleSelect">
              <option value="user" ${role==="user"?"selected":""}>User</option>
            </select>
          </td>
          <td>
            <button class="deleteBtn" data-uid="${d.id}">Delete</button>
          </td>
        </tr>
      `;
    }).join("");

    mount.innerHTML = `
      <table>
        <thead>
          <tr><th>Email</th><th>Role</th><th>Change Role</th><th>Action</th></tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
  });

  // üõ† Handle role updates
  mount.addEventListener("change", async (e) => {
    if (!e.target.classList.contains("roleSelect")) return;

    const uid = e.target.dataset.uid;
    const newRole = e.target.value;

    try {
      await updateDoc(doc(db, "users", uid), { role: newRole });
      Swal.fire("Updated!", "User role updated ‚úÖ", "success");
    } catch (err) {
      console.error("Update error:", err);
      Swal.fire("Error", "‚ùå Failed to update role", "error");
    }
  });

  // üóëÔ∏è Handle user delete
  mount.addEventListener("click", async (e) => {
    if (!e.target.classList.contains("deleteBtn")) return;

    const uid = e.target.dataset.uid;

    const confirm = await Swal.fire({
      title: "Delete this user?",
      text: "This will remove the user from Firestore (not from Firebase Auth).",
      icon: "warning",
      showCancelButton: true,
      confirmButtonText: "Yes, delete",
      cancelButtonText: "Cancel"
    });

    if (!confirm.isConfirmed) return;

    try {
      await deleteDoc(doc(db, "users", uid));
      Swal.fire("Deleted!", "User removed from Firestore ‚úÖ", "success");
    } catch (err) {
      console.error("Delete error:", err);
      Swal.fire("Error", "‚ùå Failed to delete user", "error");
    }
  });
</script>